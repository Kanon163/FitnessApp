class FitnessApp {
    constructor(storageManager, uiManager) {
        this.storage = storageManager;
        this.ui = uiManager;
        this.state = {
            currentDate: new Date(),
            settings: this.storage.getSettings(),
            library: this.storage.getLibrary(),
            history: this.storage.getHistory(),
            deferredInstallPrompt: null
        };
        this.timers = {}; // To store rest timers
    }

    init() {
        document.addEventListener('DOMContentLoaded', () => {
            this.loadTodaysWorkout();
            this.attachEventListeners();
            this.setupPWAInstall();
        });
    }
    
    // --- æ ¸å¿ƒåŠ è½½ä¸æ¸²æŸ“ ---
    loadWorkoutForDate(date) {
        this.state.currentDate = date;
        this.ui.mainContent.innerHTML = ''; // æ¸…ç©ºä¸»ç•Œé¢
        this.ui.renderDateHeader(this.state.currentDate);
        document.getElementById('unit-toggle-btn').textContent = this.state.settings.unit.toUpperCase();

        const dateKey = this.ui.getFormattedDate(this.state.currentDate);
        const workoutData = this.storage.getWorkoutByDate(dateKey);

        if (workoutData.actions && workoutData.actions.length > 0) {
            workoutData.actions.forEach(actionName => {
                const action = this.state.library.find(a => a.name === actionName);
                if (action) {
                    const setsToday = workoutData.log.filter(s => s.action === actionName);
                    const nextSetNumber = setsToday.length + 1;
                    const module = this.ui.renderActionModule(action, setsToday, nextSetNumber, this.state.settings.unit);
                    this.attachModuleEventListeners(module);
                    this.updateHistoryTips(module, action.name);
                }
            });
        }
    }

    loadTodaysWorkout() {
        this.loadWorkoutForDate(new Date());
    }

    // --- äº‹ä»¶ç›‘å¬ ---
    attachEventListeners() {
        document.getElementById('library-btn').addEventListener('click', () => this.showLibraryModal());
        document.getElementById('log-btn').addEventListener('click', () => this.showLogModal());
        document.getElementById('add-action-btn').addEventListener('click', () => this.showAddActionModal());
        document.getElementById('unit-toggle-btn').addEventListener('click', () => this.toggleUnits());
    }

    attachModuleEventListeners(module) {
        const actionName = module.dataset.actionName;

        // ç¡®è®¤æŒ‰é’®
        module.querySelector('.confirm-btn').addEventListener('click', (e) => {
            this.saveSet(module, actionName);
        });

        // çºµå‘å±•å¼€
        module.querySelector('.expand-btn').addEventListener('click', (e) => {
            this.toggleVerticalExpand(module);
        });
        
        // æ¨ªå‘å±•å¼€
        module.querySelector('.details-btn').addEventListener('click', () => {
            module.querySelector('.focus-row-wrapper').classList.add('details-visible');
        });
        
        // è¯¦ç»†æ•°æ®è¿”å›
        module.querySelector('.back-btn').addEventListener('click', () => {
             module.querySelector('.focus-row-wrapper').classList.remove('details-visible');
        });
        
        // å…¨å±€é‡å‘½å
        module.querySelector('.action-name').addEventListener('click', () => {
            this.initiateGlobalRename(actionName);
        });
        
        // åˆ é™¤æœ¬ç»„(æœªç¡®è®¤)
        module.querySelector('.delete-set-btn').addEventListener('click', () => {
            // Clears inputs in the details area
            module.querySelector('.weight-input').value = '';
            module.querySelector('.rpe-input').value = '';
            module.querySelector('.notes-input').value = '';
            module.querySelector('.reps-input').value = '';
            module.querySelector('.focus-row-wrapper').classList.remove('details-visible');
        });
        
        // è®¡æ—¶å™¨ (ç®€åŒ–ç‰ˆ)
        module.querySelector('.timer-btn').addEventListener('click', (e) => this.handleTimer(e.currentTarget, actionName));
    }

    // --- åŠ¨ä½œæ¨¡å—æ ¸å¿ƒåŠŸèƒ½ ---
    saveSet(module, actionName) {
        const repsInput = module.querySelector('.reps-input');
        const reps = parseInt(repsInput.value, 10);
        if (!reps || reps <= 0) return;

        const weight = module.querySelector('.weight-input').value || null;
        const rpe = module.querySelector('.rpe-input').value || null;
        const notes = module.querySelector('.notes-input').value.trim() || null;

        const newSet = {
            id: Date.now(),
            action: actionName,
            reps: reps,
            weight: weight ? parseFloat(weight) : null,
            rpe: rpe ? parseInt(rpe, 10) : null,
            notes: notes,
            unit: this.state.settings.unit
        };

        const dateKey = this.ui.getFormattedDate(this.state.currentDate);
        const workoutData = this.storage.getWorkoutByDate(dateKey);
        workoutData.log.push(newSet);
        this.storage.saveWorkoutForDate(dateKey, workoutData);

        // --- æ›´æ–°UI ---
        repsInput.value = '';
        module.querySelector('.weight-input').value = '';
        module.querySelector('.rpe-input').value = '';
        module.querySelector('.notes-input').value = '';
        module.querySelector('.focus-row-wrapper').classList.remove('details-visible');
        
        const setsToday = workoutData.log.filter(s => s.action === actionName);
        const nextSetNumber = setsToday.length + 1;
        
        module.querySelector('.set-counter').textContent = `ç¬¬ ${nextSetNumber} ç»„`;
        
        const setList = module.querySelector('.today-set-list');
        const setItemHTML = this.ui.createSetItemHTML(newSet, setsToday.length, this.state.settings.unit);
        setList.insertAdjacentHTML('beforeend', setItemHTML);
        module.querySelector('.today-sets-header').classList.remove('hidden');

        // è§†è§‰åé¦ˆ
        const confirmBtn = module.querySelector('.confirm-btn');
        confirmBtn.style.backgroundColor = 'var(--success-color)';
        setTimeout(() => { confirmBtn.style.backgroundColor = '' }, 300);
        
        repsInput.focus();
    }
    
    toggleVerticalExpand(module) {
        const historyArea = module.querySelector('.history-area');
        const expandBtn = module.querySelector('.expand-btn');
        const isExpanded = historyArea.classList.toggle('expanded');
        expandBtn.setAttribute('aria-expanded', isExpanded);
        expandBtn.classList.toggle('expanded');
    }

    updateHistoryTips(module, actionName) {
        const bestTipEl = module.querySelector('.history-tip[data-type="best"]');
        const lastTipEl = module.querySelector('.history-tip[data-type="last"]');
        
        let bestSet = null;
        let lastSet = null;
        let lastDate = '';

        const sortedDates = Object.keys(this.state.history).sort().reverse();
        
        for (const dateKey of sortedDates) {
            const workout = this.state.history[dateKey];
            const setsForAction = workout.log.filter(s => s.action === actionName && s.weight && s.reps);
            
            if (setsForAction.length > 0) {
                 if (!lastSet) {
                    lastSet = setsForAction[setsForAction.length - 1]; // last set of the most recent day
                    lastDate = dateKey;
                 }
                 
                 for (const set of setsForAction) {
                    const volume = set.weight * set.reps;
                    if (!bestSet || volume > (bestSet.weight * bestSet.reps)) {
                        bestSet = set;
                    }
                 }
            }
        }
        
        if (bestSet) {
            bestTipEl.textContent = `å†å²æœ€ä½³: ${bestSet.reps} æ¬¡ @ ${bestSet.weight} ${bestSet.unit}`;
        }
        if (lastSet) {
            lastTipEl.textContent = `ä¸Šæ¬¡è®­ç»ƒ (${lastDate}): ${lastSet.reps} æ¬¡ @ ${lastSet.weight} ${lastSet.unit}`;
        }
    }
    
    // --- åŠ¨ä½œåº“ç®¡ç† ---
    showLibraryModal() {
        const library = this.storage.getLibrary();
        let content = `<div class="item-list">`;
        if (library.length === 0) {
            content += `<p>åŠ¨ä½œåº“ä¸ºç©ºï¼Œè¯·æ·»åŠ æ–°åŠ¨ä½œã€‚</p>`;
        } else {
            content += library.map(action => `
                <div class="list-item" data-action-name="${action.name}">
                    <div class="item-info">
                        <div class="item-name">${action.name}</div>
                        <div class="item-tags">${action.tags.join(', ')}</div>
                    </div>
                    <div class="item-actions">
                        <button class="edit-action-btn">âœï¸</button>
                        <button class="delete-action-btn">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        }
        content += `</div>`;
        
        const footer = `
            <input type="file" id="import-csv" accept=".csv" style="display:none;">
            <button id="import-btn" class="modal-button secondary-btn">å¯¼å…¥CSV</button>
            <button id="export-btn" class="modal-button secondary-btn">å¯¼å‡ºCSV</button>
            <button id="add-new-action-btn" class="modal-button primary-btn">æ–°å¢åŠ¨ä½œ</button>
        `;

        this.ui.showModal('åŠ¨ä½œåº“ç®¡ç†', content, footer);
        this.attachLibraryModalListeners();
    }
    
    attachLibraryModalListeners() {
        // æ–°å¢
        document.getElementById('add-new-action-btn').addEventListener('click', () => this.showAddEditActionModal());
        
        // ç¼–è¾‘å’Œåˆ é™¤
        document.querySelectorAll('.edit-action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const actionName = e.target.closest('.list-item').dataset.actionName;
                const action = this.state.library.find(a => a.name === actionName);
                this.showAddEditActionModal(action);
            });
        });
        document.querySelectorAll('.delete-action-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const actionName = e.target.closest('.list-item').dataset.actionName;
                this.ui.showConfirm('åˆ é™¤åŠ¨ä½œ', `ç¡®å®šè¦åˆ é™¤ "${actionName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, () => {
                    this.deleteAction(actionName);
                });
            });
        });
        
        // å¯¼å…¥å¯¼å‡º
        document.getElementById('export-btn').addEventListener('click', () => this.exportLibraryToCSV());
        document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-csv').click());
        document.getElementById('import-csv').addEventListener('change', (e) => this.importLibraryFromCSV(e));
    }
    
    showAddEditActionModal(action = null) {
        const isEditing = !!action;
        const title = isEditing ? 'ç¼–è¾‘åŠ¨ä½œ' : 'æ–°å¢åŠ¨ä½œ';
        const name = isEditing ? action.name : '';
        const tags = isEditing ? action.tags.join(', ') : '';
        
        const content = `
            <div class="form-group">
                <label for="action-name-input">åŠ¨ä½œåç§°</label>
                <input type="text" id="action-name-input" value="${name}" ${isEditing ? 'disabled' : ''}>
            </div>
             <div class="form-group">
                <label for="action-tags-input">æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)</label>
                <input type="text" id="action-tags-input" value="${tags}">
            </div>
        `;
        const footer = `<button id="save-action-btn" class="modal-button primary-btn">ä¿å­˜</button>`;
        this.ui.showModal(title, content, footer);
        
        document.getElementById('save-action-btn').addEventListener('click', () => {
            const newName = document.getElementById('action-name-input').value.trim();
            const newTags = document.getElementById('action-tags-input').value.trim().split(',').map(t => t.trim()).filter(Boolean);
            
            if (!newName) {
                alert('åŠ¨ä½œåç§°ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            
            const newAction = { name: newName, tags: newTags };
            
            if (isEditing) {
                // åªæ›´æ–°æ ‡ç­¾
                const index = this.state.library.findIndex(a => a.name === action.name);
                this.state.library[index] = newAction;
            } else {
                 if (this.state.library.some(a => a.name.toLowerCase() === newName.toLowerCase())) {
                    alert('è¯¥åŠ¨ä½œå·²å­˜åœ¨ï¼');
                    return;
                }
                this.state.library.push(newAction);
            }
            
            this.storage.saveLibrary(this.state.library);
            this.showLibraryModal(); // Refresh the list
        });
    }

    deleteAction(actionName) {
        this.state.library = this.state.library.filter(a => a.name !== actionName);
        this.storage.saveLibrary(this.state.library);
        
        // Also remove from today's workout if present
        const dateKey = this.ui.getFormattedDate(this.state.currentDate);
        const workoutData = this.storage.getWorkoutByDate(dateKey);
        workoutData.actions = workoutData.actions.filter(name => name !== actionName);
        this.storage.saveWorkoutForDate(dateKey, workoutData);

        this.loadWorkoutForDate(this.state.currentDate); // Refresh main UI
        this.showLibraryModal(); // Refresh library UI
    }
    
    initiateGlobalRename(oldName) {
        this.ui.showPrompt('å…¨å±€é‡å‘½å', `ä¸º "${oldName}" è¾“å…¥æ–°åç§°`, oldName, (newName) => {
            if (newName && newName !== oldName) {
                if (this.state.library.some(a => a.name.toLowerCase() === newName.toLowerCase())) {
                    alert('æ–°åç§°å·²å­˜åœ¨äºåŠ¨ä½œåº“ä¸­ï¼');
                    return;
                }

                this.ui.showConfirm(
                    'è­¦å‘Šï¼šä¸å¯æ’¤é”€æ“ä½œ',
                    `ç¡®å®šè¦å°†æ‰€æœ‰è®°å½•ä¸­çš„ "${oldName}" é‡å‘½åä¸º "${newName}" å—ï¼Ÿè¿™å°†ä¿®æ”¹å…¨éƒ¨å†å²æ•°æ®ã€‚`,
                    () => this.executeGlobalRename(oldName, newName)
                );
            }
        });
    }

    executeGlobalRename(oldName, newName) {
        // 1. Update library
        const actionIndex = this.state.library.findIndex(a => a.name === oldName);
        if (actionIndex > -1) {
            this.state.library[actionIndex].name = newName;
        }
        this.storage.saveLibrary(this.state.library);

        // 2. Update history
        const history = this.state.history;
        for (const dateKey in history) {
            // Update actions array
            const actionIndexInDay = history[dateKey].actions.indexOf(oldName);
            if (actionIndexInDay > -1) {
                history[dateKey].actions[actionIndexInDay] = newName;
            }
            // Update each log entry
            history[dateKey].log.forEach(set => {
                if (set.action === oldName) {
                    set.action = newName;
                }
            });
        }
        this.storage.saveHistory(history);
        this.state.history = history; // Update local state

        // 3. Refresh UI
        this.loadWorkoutForDate(this.state.currentDate);
        alert('é‡å‘½åæˆåŠŸï¼');
    }
    
    // --- CSV å¯¼å…¥/å¯¼å‡º ---
    exportLibraryToCSV() {
        const library = this.storage.getLibrary();
        if (library.length === 0) {
            alert('åŠ¨ä½œåº“ä¸ºç©ºï¼');
            return;
        }
        let csvContent = "data:text/csv;charset=utf-8,name,tags\n";
        library.forEach(action => {
            const row = `${action.name},"${action.tags.join(',')}"`;
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "fitness_action_library.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    importLibraryFromCSV(event) {
        const file = event.target.files[0];
        if (!file) return;

        this.ui.showConfirm('å¯¼å…¥ç¡®è®¤', 'è¿™å°†è¦†ç›–æ‚¨å½“å‰çš„æ•´ä¸ªåŠ¨ä½œåº“ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ', () => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const rows = text.split('\n').slice(1); // Skip header
                    const newLibrary = [];
                    rows.forEach(row => {
                        if (row.trim()) {
                            const columns = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                            if (columns && columns.length >= 2) {
                                const name = columns[0].trim();
                                const tags = columns[1].replace(/"/g, '').split(',').map(t => t.trim()).filter(Boolean);
                                newLibrary.push({ name, tags });
                            }
                        }
                    });
                    this.state.library = newLibrary;
                    this.storage.saveLibrary(newLibrary);
                    this.showLibraryModal();
                    alert('å¯¼å…¥æˆåŠŸï¼');
                } catch (error) {
                    alert('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡® (name,tags)');
                    console.error('CSV import error:', error);
                }
            };
            reader.readAsText(file);
        });
    }

    
    // --- æ—¥å¿—ä¸å†å² ---
    showLogModal() {
        const history = this.storage.getHistory();
        const sortedDates = Object.keys(history).sort().reverse();
        
        let content = `<div class="log-list">`;
        if (sortedDates.length === 0) {
            content += `<p>æš‚æ— è®­ç»ƒæ—¥å¿—ã€‚</p>`;
        } else {
            content += sortedDates.map(dateKey => `
                <label class="date-item" data-date-key="${dateKey}">
                    <input type="checkbox" class="date-checkbox">
                    <span>${dateKey} (${history[dateKey].actions.length}ä¸ªåŠ¨ä½œ)</span>
                </label>
            `).join('');
        }
        content += `</div>`;
        
        const footer = `<button id="export-log-btn" class="modal-button primary-btn">å¯¼å‡ºé€‰ä¸­æ—¥å¿— (CSV)</button>`;
        this.ui.showModal('è®­ç»ƒæ—¥å¿—', content, footer);
        
        document.querySelectorAll('.date-item').forEach(item => {
            item.addEventListener('click', (e) => {
                // Prevent checkbox click from triggering navigation
                if (e.target.type === 'checkbox') return;
                
                const dateKey = e.currentTarget.dataset.dateKey;
                const [year, month, day] = dateKey.split('-').map(Number);
                // JS month is 0-indexed
                const selectedDate = new Date(year, month - 1, day);
                this.loadWorkoutForDate(selectedDate);
                this.ui.hideModal();
            });
        });
        
        document.getElementById('export-log-btn').addEventListener('click', () => this.exportSelectedLogsToCSV());
    }
    
    exportSelectedLogsToCSV() {
        const selectedDates = [];
        document.querySelectorAll('.date-checkbox:checked').forEach(cb => {
            selectedDates.push(cb.closest('.date-item').dataset.dateKey);
        });

        if (selectedDates.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ—¥æœŸï¼');
            return;
        }

        const history = this.storage.getHistory();
        let csvContent = "data:text/csv;charset=utf-8,date,action,set,reps,weight,unit,rpe,notes\n";
        
        selectedDates.sort().forEach(dateKey => {
            const workout = history[dateKey];
            const actionSetCounters = {};
            workout.log.forEach(set => {
                if (actionSetCounters[set.action] === undefined) {
                    actionSetCounters[set.action] = 1;
                } else {
                    actionSetCounters[set.action]++;
                }
                const row = [
                    dateKey,
                    `"${set.action}"`,
                    actionSetCounters[set.action],
                    set.reps || '',
                    set.weight || '',
                    set.unit || '',
                    set.rpe || '',
                    `"${set.notes || ''}"`
                ].join(',');
                csvContent += row + "\n";
            });
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `fitness_log_${selectedDates.join('_')}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // --- æ·»åŠ ä»Šæ—¥åŠ¨ä½œ ---
    showAddActionModal() {
        const dateKey = this.ui.getFormattedDate(this.state.currentDate);
        const todaysActions = this.storage.getWorkoutByDate(dateKey).actions || [];
        const availableActions = this.state.library.filter(a => !todaysActions.includes(a.name));

        let content = `<div class="item-list">`;
        if (availableActions.length > 0) {
            content += availableActions.map(action => `
                <div class="list-item add-action-item" data-action-name="${action.name}" style="cursor:pointer;">
                    <div class="item-info">
                        <div class="item-name">${action.name}</div>
                        <div class="item-tags">${action.tags.join(', ')}</div>
                    </div>
                </div>
            `).join('');
        } else {
            content += `<p>æ‰€æœ‰åº“å†…åŠ¨ä½œéƒ½å·²æ·»åŠ ï¼Œæˆ–åŠ¨ä½œåº“ä¸ºç©ºã€‚</p>`;
        }
        content += `</div>`;
        
        this.ui.showModal('é€‰æ‹©è¦æ·»åŠ çš„åŠ¨ä½œ', content);
        
        document.querySelectorAll('.add-action-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const actionName = e.currentTarget.dataset.actionName;
                this.addActionToToday(actionName);
                this.ui.hideModal();
            });
        });
    }
    
    addActionToToday(actionName) {
        const dateKey = this.ui.getFormattedDate(this.state.currentDate);
        const workoutData = this.storage.getWorkoutByDate(dateKey);
        
        if (!workoutData.actions) {
            workoutData.actions = [];
        }

        if (!workoutData.actions.includes(actionName)) {
            workoutData.actions.push(actionName);
            this.storage.saveWorkoutForDate(dateKey, workoutData);
            this.loadWorkoutForDate(this.state.currentDate); // Reload to show the new module
        }
    }
    
    // --- è®¾ç½® ---
    toggleUnits() {
        this.state.settings.unit = this.state.settings.unit === 'kg' ? 'lbs' : 'kg';
        this.storage.saveSettings(this.state.settings);
        this.loadWorkoutForDate(this.state.currentDate); // Reload to reflect unit changes
    }
    
    // --- è®¡æ—¶å™¨ ---
    handleTimer(button, actionName) {
        if (this.timers[actionName] && this.timers[actionName].intervalId) {
            // Stop timer
            clearInterval(this.timers[actionName].intervalId);
            delete this.timers[actionName];
            button.textContent = 'â±';
            button.style.color = '';
        } else {
            // Start timer
            const startTime = Date.now();
            this.timers[actionName] = { startTime };
            
            this.timers[actionName].intervalId = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = String(Math.floor(elapsed / 60)).padStart(2, '0');
                const seconds = String(elapsed % 60).padStart(2, '0');
                button.textContent = `${minutes}:${seconds}`;
            }, 1000);
            
            button.style.color = 'var(--secondary-color)';
        }
    }

    // --- PWA å®‰è£… ---
    setupPWAInstall() {
        const installBtn = document.getElementById('pwa-install-btn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            this.state.deferredInstallPrompt = e;
            installBtn.style.display = 'block';
        });

        installBtn.addEventListener('click', () => {
            installBtn.style.display = 'none';
            if (this.state.deferredInstallPrompt) {
                this.state.deferredInstallPrompt.prompt();
                this.state.deferredInstallPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the A2HS prompt');
                    } else {
                        console.log('User dismissed the A2HS prompt');
                    }
                    this.state.deferredInstallPrompt = null;
                });
            }
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            installBtn.style.display = 'none';
        });
    }

}

// --- åº”ç”¨å¯åŠ¨ ---
const app = new FitnessApp(storage, ui);
app.init();